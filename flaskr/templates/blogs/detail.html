{% extends "/layout.html" %}

{% block title %}{{ blog.title }}{% endblock %}
{% block h1 %}{{ blog.title }}{% endblock %}

{% block content %}
    <p>投稿者: {{ blog.user_name }}</p>
    <p>投稿日: {{ blog.created_at.strftime('%Y-%m-%d %H:%M') }}</p>

    <hr>
    <p>{{ blog.body }}</p>

    <div class="detail-actions">
        <p>
            <a href="{{ url_for('blogs.edit', blog_id=blog.id) }}">編集</a>
        </p>
        <form action="{{ url_for('blogs.delete', blog_id=blog.id) }}" method="post" style="display:inline;">
            <button type="submit" onclick="return confirm('本当に削除しますか？')">削除</button>
        </form>
    </div>

    <h2>コメント</h2>
    {% if blog.comments %}
        <ul id="comment-list">
            {% for c in blog.comments %}
            <li>
                <strong>{{ c.user_name }}</strong> ({{ c.created_at.strftime('%Y-%m-%d %H:%M') }})<br>
                {{ c.body }}
            </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>まだコメントはありません。</p>
    {% endif %}
    <hr>

    <h3>コメントを書く</h3>
    <form method="POST" action="{{ url_for('blogs.add_comment', blog_id=blog.id) }}">
    <label>名前：</label><br>
    <input type="text" name="user_name"><br><br>

    <label>コメント：</label><br>
    <textarea name="body" rows="4"></textarea><br><br>

    <button type="submit">投稿</button>
    </form>

    <div style="margin-top: 20px;">
        <button id="ai-comment-btn" data-blog-id="{{ blog.id }}" style="background-color: #a8dadc; color: #555;">
        AIコメントを追加する
        </button>
    </div>

    <script>
    document.getElementById("ai-comment-btn").addEventListener("click", function() {
        const blogId = this.dataset.blogId;
        // ボタンを押したら「考え中...」に変える演出（任意）
        const btn = this;
        const originalText = btn.innerText;
        btn.innerText = "考え中...";
        btn.disabled = true;

        fetch(`/blogs/${blogId}/ai-comment`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const li = document.createElement("li");
                li.innerHTML = `<strong>${data.user_name}:</strong> ${data.body}`;
                document.getElementById("comment-list").appendChild(li);
            } else {
                alert("コメント追加に失敗しました");
            }
            // ボタンを元に戻す
            btn.innerText = originalText;
            btn.disabled = false;
        });
    });
    </script>

    <p><a href="{{ url_for('blogs.index') }}">← 一覧に戻る</a></p>
{% endblock %}